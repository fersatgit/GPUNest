#version 460
#define c vec2(.5,.25)
#define d 3.1415926535897932384626433832795
layout(binding=0)buffer SSBO0{ivec4 DistanceMap[128];};layout(binding=1)buffer SSBO1{uint PlacementMap[];};layout(binding=2)buffer SSBO2{uint FrameBuffer[];};layout(location=0)uniform vec4 Param;layout(location=1)uniform int Rotations;layout(points,invocations=64)in;layout(triangle_strip,max_vertices=4)out;out vec2 TexCoord;void main(){if(gl_InvocationID>>Rotations==0){uint e=gl_InvocationID<<(6-Rotations);float f=e*d/32;ivec4 g=DistanceMap[e+0];ivec4 h=DistanceMap[e+16];ivec4 j=DistanceMap[e+32];ivec4 k=DistanceMap[e+48];ivec2 l;switch(int(gl_in[0].gl_Position.w)){case 0:l=ivec2(gl_in[0].gl_Position.xy)-ivec2(0,k.z+j.y);break;case 1:l=ivec2(gl_in[0].gl_Position.xy)+ivec2(j.x-k.y,0);break;case 2:l=ivec2(gl_in[0].gl_Position.xy)+ivec2(-k.y,h.x)-ivec2(h.y,j.y);break;}ivec2 m=ivec2(k.y,j.y)+ivec2(h.y,g.y)+l;gl_PrimitiveID=(int(gl_in[0].gl_Position.z)<<Rotations)+gl_InvocationID;if(any(lessThan(vec4(l.xy,Param.zw),vec4(0,0,m)))){PlacementMap[gl_PrimitiveID]=0xFFFFFFFF;return;}vec4 n=fma(vec4(l,m),2/Param.zwzw,vec4(-1,-1,-1,-1));ivec2 o=ivec2(l+ivec2(k.y,j.y));ivec3 p=(o.yyy-ivec3(-k.x,j.y,h.x))*ivec3(Param.zzz)+o.xxx-ivec3(k.y+1,j.x,1-h.y);if(any(greaterThan(uvec3(FrameBuffer[p.x],FrameBuffer[p.y],FrameBuffer[p.z]),uvec3(0,0,0)))){PlacementMap[gl_PrimitiveID]=0xFFFFFFFF;return;}float q=atan(k.y,g.y)-f;gl_Position=vec4(n.xw,0,1);TexCoord=fma(vec2(-sin(q),cos(q))*length(vec2(k.y,g.y)),Param.xy,c);EmitVertex();q=-atan(h.y,g.y)-f;gl_Position=vec4(n.zw,0,1);TexCoord=fma(vec2(-sin(q),cos(q))*length(vec2(h.y,g.y)),Param.xy,c);EmitVertex();q=d-atan(k.y,j.y)-f;gl_Position=vec4(n.xy,0,1);TexCoord=fma(vec2(-sin(q),cos(q))*length(vec2(k.y,j.y)),Param.xy,c);EmitVertex();q=d+atan(h.y,j.y)-f;gl_Position=vec4(n.zy,0,1);TexCoord=fma(vec2(-sin(q),cos(q))*length(vec2(h.y,j.y)),Param.xy,c);EmitVertex();EndPrimitive();}}